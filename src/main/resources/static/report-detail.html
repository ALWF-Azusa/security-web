<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼±é»æƒæè©³æƒ…</title>
    <style>
        /* === åŸºç¤è¨­å®š === */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        a { text-decoration: none; color: #2980b9; }
        a:hover { text-decoration: underline; }

        /* === é ‚éƒ¨å°èˆªèˆ‡è³‡è¨Š === */
        .header-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }
        .btn-back { padding: 8px 16px; background-color: #95a5a6; color: white; border-radius: 5px; font-weight: bold; transition: 0.3s; }
        .btn-back:hover { background-color: #7f8c8d; text-decoration: none; }
        .report-title { margin: 0; font-size: 1.8em; color: #2c3e50; }
        .meta-info { color: #7f8c8d; font-size: 0.9em; margin-top: 5px; }

        /* === é¢¨éšªç­‰ç´šæ¨™ç±¤ (Badge) === */
        .badge { display: inline-block; padding: 5px 12px; border-radius: 15px; color: white; font-size: 0.85em; font-weight: bold; min-width: 80px; text-align: center; }
        .risk-High { background-color: #e74c3c; }
        .risk-Medium { background-color: #e67e22; }
        .risk-Low { background-color: #f1c40f; color: #333; }
        .risk-Informational { background-color: #3498db; }
        .risk-False { background-color: #2ecc71; }

        /* === Section 1: Summary è¡¨æ ¼ === */
        .section-title { font-size: 1.4em; border-left: 5px solid #2c3e50; padding-left: 10px; margin-bottom: 15px; margin-top: 40px; color: #34495e; }

        .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
        .summary-table th, .summary-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        .summary-table th { background-color: #f8f9fa; color: #555; font-weight: 600; }
        .summary-table tr:hover { background-color: #eef2f3; cursor: pointer; transform: scale(1.005); transition: 0.1s; }

        /* === Section 2: Alert Details (æ‘ºç–Šæ¨£å¼å„ªåŒ–) === */
        .alert-block { border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; overflow: hidden; background: white; transition: box-shadow 0.3s; }
        .alert-block.active { box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #bdc3c7; }

        /* æ¨™é¡Œåˆ—ï¼šå¯é»æ“Š */
        .alert-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid transparent;
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        .alert-header:hover { background-color: #ecf0f1; }

        /* ç•¶å±•é–‹æ™‚ï¼Œæ¨™é¡Œåˆ—ä¸‹æ–¹è¦æœ‰ç·š */
        .alert-block.active .alert-header { border-bottom: 1px solid #ddd; background-color: #fff; }

        .alert-title-group { display: flex; align-items: center; gap: 10px; }
        .alert-name { font-size: 1.1em; font-weight: bold; color: #2c3e50; }

        /* ç®­é ­å‹•ç•« */
        .arrow-icon { transition: transform 0.3s ease; color: #7f8c8d; font-size: 0.8em; }
        .alert-block.active .arrow-icon { transform: rotate(180deg); }

        /* å…§å®¹å€å¡Šï¼šé è¨­éš±è— */
        .alert-body {
            display: none; /* ğŸ”¥ é—œéµï¼šé è¨­éš±è— */
            padding: 20px;
            animation: fadeIn 0.4s ease;
        }
        /* ç•¶æœ‰ active class æ™‚é¡¯ç¤º */
        .alert-block.active .alert-body { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-row { margin-bottom: 15px; }
        .info-label { font-weight: bold; color: #555; display: block; margin-bottom: 5px; }
        .info-content { color: #444; line-height: 1.6; background: #fafafa; padding: 10px; border-radius: 5px; border-left: 3px solid #ddd; }

        /* === Instances è¡¨æ ¼ === */
        .instance-table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px; table-layout: fixed; }
        .instance-table th, .instance-table td { padding: 8px; border: 1px solid #eee; vertical-align: top; word-wrap: break-word; }
        .instance-table th { background-color: #eee; width: 15%; }

        .code-snippet {
            font-family: Consolas, Monaco, 'Courier New', monospace;
            background: #fdf6e3; color: #d33682;
            padding: 2px 5px; border-radius: 3px;
            word-break: break-all;
            display: block;
            max-height: 150px;
            overflow-y: auto;
        }

        /* é€™æ˜¯çµ¦ JS æ§åˆ¶æ²å‹•æ™‚çš„é«˜äº®æ•ˆæœ */
        .highlight-pulse { animation: pulse 1s 2; }
        @keyframes pulse {
            0% { background-color: #fff; }
            50% { background-color: #fff3cd; }
            100% { background-color: #fff; }
        }

    </style>
</head>
<body>

<div class="container">

    <div class="header-bar">
        <div>
            <h1 class="report-title" id="siteTitle">Loading...</h1>
            <div class="meta-info" id="metaInfo">Loading...</div>
        </div>
        <a href="/dashboard.html" class="btn-back">â† å›å„€è¡¨æ¿</a>
    </div>

    <h2 class="section-title">Summary of Sequences (å¼±é»æ¸…å–®ç¸½è¡¨)</h2>
    <p style="color:#666; font-size:0.9em; margin-bottom: 10px;">ğŸ‘‡ é»æ“Šè¡¨æ ¼åˆ—å¯å¿«é€Ÿå±•é–‹è©³ç´°å…§å®¹</p>

    <div style="text-align: right; margin-bottom: 5px;">
        <button onclick="toggleAll(true)" style="cursor:pointer; border:1px solid #ddd; background:white; padding:5px 10px; border-radius:4px;">å±•é–‹å…¨éƒ¨</button>
        <button onclick="toggleAll(false)" style="cursor:pointer; border:1px solid #ddd; background:white; padding:5px 10px; border-radius:4px;">æ”¶åˆå…¨éƒ¨</button>
    </div>

    <table class="summary-table">
        <thead>
        <tr>
            <th style="width: 15%;">Risk Level</th>
            <th style="width: 70%;">Alert Name (æ”»æ“Šé¡åˆ¥)</th>
            <th style="width: 15%;">Instances</th>
        </tr>
        </thead>
        <tbody id="summaryBody">
        <tr><td colspan="3" style="text-align: center;">æ­£åœ¨è¼‰å…¥æ•¸æ“š...</td></tr>
        </tbody>
    </table>

    <h2 class="section-title">Alert Detail (å¼±é»è©³ç´°åˆ†æ)</h2>
    <div id="detailContainer">
    </div>

</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const reportId = urlParams.get('id');

    const targetAlert = urlParams.get('target');

    if (!reportId) { /* ... ç•¥ ... */ }

    fetch(`/api/reports/${reportId}`)
        .then(res => res.json())
        .then(report => {
            renderHeader(report);
            renderSummary(report.scanAlerts);
            renderDetails(report.scanAlerts);

            // ğŸ”¥ 2. è‡ªå‹•æ»‘å‹•é‚è¼¯
            if (targetAlert) {
                // åœ¨å ±å‘Šè£¡å°‹æ‰¾åç¨±ç¬¦åˆçš„å¼±é» index
                // decodeURIComponent è§£ç¢¼ (æŠŠ %20 è®Šå›ç©ºç™½)
                const decodedTarget = decodeURIComponent(targetAlert);

                // ä½¿ç”¨ findIndex æ‰¾ä½ç½®
                const targetIndex = report.scanAlerts.findIndex(a => a.alertName === decodedTarget);

                if (targetIndex !== -1) {
                    // ç¨å¾®å»¶é²ä¸€é»é»ï¼Œç¢ºä¿ç•«é¢æ¸²æŸ“å®Œç•¢å¾Œå†è·³è½‰ï¼Œé«”é©—è¼ƒå¥½
                    setTimeout(() => {
                        jumpToAlert(targetIndex);
                    }, 300);
                }
            }
        })
        .catch(err => {
            console.error(err);
            document.getElementById('siteTitle').innerText = "è¼‰å…¥å¤±æ•—";
            document.getElementById('summaryBody').innerHTML = '<tr><td colspan="3" style="color:red; text-align:center;">ç„¡æ³•è®€å–å ±å‘Šè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</td></tr>';
        });

    function renderHeader(report) {
        const displayTitle = report.siteUrl.replace(' (HTTPS)', '').replace(' (HTTP)', '');
        document.getElementById('siteTitle').innerText = displayTitle;
        const dateStr = new Date(report.generatedOn).toLocaleString('zh-TW', { hour12: false });
        document.getElementById('metaInfo').innerHTML =
            `ğŸ“… æƒææ™‚é–“: ${dateStr} &nbsp;|&nbsp; ğŸ›¡ï¸ ZAP Version: ${report.zapVersion}`;
    }

    function renderSummary(alerts) {
        const tbody = document.getElementById('summaryBody');
        let html = '';
        const riskOrder = { 'High': 1, 'Medium': 2, 'Low': 3, 'Informational': 4, 'False Positive': 5 };
        alerts.sort((a, b) => (riskOrder[a.riskLevel] || 99) - (riskOrder[b.riskLevel] || 99));

        if (alerts.length === 0) {
            html = '<tr><td colspan="3" style="text-align:center; padding:20px;">ğŸ‰ æ­å–œï¼æœ¬å ±å‘Šæœªç™¼ç¾ä»»ä½•å¼±é»ã€‚</td></tr>';
        } else {
            alerts.forEach((alert, index) => {
                // ğŸ”¥ ä¿®æ”¹é‡é»ï¼šé»æ“Šæ™‚å‘¼å« jumpToAlert
                html += `
                    <tr onclick="jumpToAlert(${index})" title="é»æ“Šå±•é–‹è©³æƒ…">
                        <td><span class="badge risk-${alert.riskLevel.split(' ')[0]}">${alert.riskLevel}</span></td>
                        <td style="font-weight: 500; color: #2c3e50;">${alert.alertName}</td>
                        <td style="font-weight: bold; text-align: center;">${alert.riskCount}</td>
                    </tr>
                `;
            });
        }
        tbody.innerHTML = html;
    }

    function renderDetails(alerts) {
        const container = document.getElementById('detailContainer');
        let html = '';

        alerts.forEach((alert, index) => {
            let instanceHtml = '';
            if (alert.alertInstances && alert.alertInstances.length > 0) {
                instanceHtml = `
                    <div style="margin-top: 15px;">
                        <span class="info-label">ğŸ”´ Vulnerable Instances (å—å½±éŸ¿çš„ç¶²å€/åƒæ•¸):</span>
                        <table class="instance-table">
                            <thead>
                                <tr>
                                    <th style="width:10%">Method</th>
                                    <th style="width:30%">URL</th>
                                    <th style="width:20%">Attack / Param</th>
                                    <th style="width:40%">Evidence</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                alert.alertInstances.forEach(inst => {
                    instanceHtml += `
                        <tr>
                            <td>${inst.method}</td>
                            <td style="word-break: break-all;">${inst.url}</td>
                            <td>
                                <div style="font-weight:bold;">${inst.parameter || '-'}</div>
                                ${inst.attack ? `<span class="code-snippet">${inst.attack}</span>` : ''}
                            </td>
                            <td>${inst.evidence ? `<span class="code-snippet">${inst.evidence}</span>` : '-'}</td>
                        </tr>`;
                });
                instanceHtml += `</tbody></table></div>`;
            }

            // ğŸ”¥ ä¿®æ”¹é‡é»ï¼šå¢åŠ  onclick="toggleDetail(index)" å’Œç®­é ­åœ–ç¤º
            html += `
                <div id="alert-${index}" class="alert-block">
                    <div class="alert-header" onclick="toggleDetail(${index})">
                        <div class="alert-title-group">
                            <span id="arrow-${index}" class="arrow-icon">â–¼</span>
                            <span class="alert-name">${alert.alertName}</span>
                        </div>
                        <span class="badge risk-${alert.riskLevel.split(' ')[0]}">${alert.riskLevel}</span>
                    </div>

                    <div class="alert-body">
                        <div class="info-row">
                            <span class="info-label">ğŸ“ Description:</span>
                            <div class="info-content">${alert.description}</div>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ğŸ’¡ Solution:</span>
                            <div class="info-content">${alert.solution}</div>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ğŸ“š Reference:</span>
                            <div class="info-content">
                                CWE ID: <a href="https://cwe.mitre.org/data/definitions/${alert.cweId}.html" target="_blank">${alert.cweId}</a>
                                &nbsp;|&nbsp; WASC ID: ${alert.wascId}
                            </div>
                        </div>
                        ${instanceHtml}
                    </div>
                </div>
            `;
        });
        container.innerHTML = html || '<div style="text-align:center; color:#777;">ç„¡è©³ç´°è³‡æ–™</div>';
    }

    // === ğŸ”¥ æ–°å¢ï¼šæ§åˆ¶å±•é–‹èˆ‡æ”¶åˆçš„é‚è¼¯ ===

    // 1. åˆ‡æ›å–®ä¸€å€å¡Šçš„é–‹é—œ (é»æ“Š Header æ™‚è§¸ç™¼)
    function toggleDetail(index) {
        const block = document.getElementById(`alert-${index}`);
        block.classList.toggle('active');
    }

    // 2. å¾ä¸Šæ–¹è¡¨æ ¼è·³è½‰ä¸¦å¼·åˆ¶å±•é–‹ (é»æ“Š Summary æ™‚è§¸ç™¼)
    function jumpToAlert(index) {
        const block = document.getElementById(`alert-${index}`);

        // å¦‚æœåŸæœ¬æ˜¯é—œçš„ï¼Œå°±æ‰“é–‹å®ƒ
        if (!block.classList.contains('active')) {
            block.classList.add('active');
        }

        // æ²å‹•éå»
        block.scrollIntoView({behavior: 'smooth', block: 'start'});

        // åŠ å€‹é–ƒçˆç‰¹æ•ˆæé†’ä½¿ç”¨è€…æ˜¯é€™ä¸€å€‹
        block.classList.add('highlight-pulse');
        setTimeout(() => block.classList.remove('highlight-pulse'), 2000);
    }

    // 3. å…¨éƒ¨å±•é–‹ / å…¨éƒ¨æ”¶åˆ
    function toggleAll(shouldOpen) {
        const blocks = document.querySelectorAll('.alert-block');
        blocks.forEach(block => {
            if (shouldOpen) block.classList.add('active');
            else block.classList.remove('active');
        });
    }
</script>

</body>
</html>