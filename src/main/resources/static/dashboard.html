<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡å®‰å¼±é»å„€è¡¨æ¿</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; position: relative; }
        h1, h2 { color: #333; text-align: center; }

        /* --- ä¸Šå‚³æŒ‰éˆ•å€ --- */
        .upload-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .btn-upload {
            background-color: #2c3e50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.3s;
        }
        .btn-upload:hover { background-color: #34495e; }
        .btn-upload:active { transform: translateY(1px); }

        /* --- [æ–°å¢] å³ä¸‹è§’ä¸Šå‚³ç‹€æ…‹æ¸…å–®æ¨£å¼ --- */
        .upload-status-box {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 400px; /* è¶…éé«˜åº¦æœƒå‡ºç¾æ²è»¸ */
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            overflow-y: auto;
            padding: 15px;
            display: none; /* é è¨­éš±è—ï¼Œæœ‰ä¸Šå‚³æ‰é¡¯ç¤º */
            z-index: 1000;
        }

        /* æ¸…å–®ä¸­çš„æ¯ä¸€åˆ— */
        .status-item {
            font-size: 0.9em;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ç‹€æ…‹æ–‡å­—é¡è‰² */
        .status-success { color: green; font-weight: bold; }
        .status-error { color: red; font-weight: bold; }
        .status-loading { color: #2980b9; }

        /* --- ä¸Šæ–¹åœ“åœˆçµ±è¨ˆå€ --- */
        .summary-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .risk-circle {
            width: 140px; height: 140px;
            border-radius: 50%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 5px solid #ddd;
            transition: transform 0.2s;
        }
        .risk-circle:hover { transform: scale(1.05); }
        .risk-count { font-size: 2.5em; font-weight: bold; color: #333; }
        .risk-label { font-size: 0.9em; color: #777; text-transform: uppercase; margin-top: 5px; }

        /* é¢¨éšªé¡è‰²å®šç¾© */
        .border-high { border-color: #e74c3c; color: #e74c3c; }
        .border-medium { border-color: #e67e22; color: #e67e22; }
        .border-low { border-color: #f1c40f; color: #f39c12; }
        .border-info { border-color: #3498db; color: #3498db; }
        .border-false { border-color: #2ecc71; color: #2ecc71; }

        /* --- ä¸‹æ–¹ç¶²ç«™åˆ—è¡¨å€ --- */
        .table-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; color: #555; font-weight: 600; }
        tr:hover { background-color: #f1f1f1; }

        .site-link { color: #2980b9; text-decoration: none; font-weight: bold; }
        .site-link:hover { text-decoration: underline; }

        /* åˆ—è¡¨å¾½ç«  */
        .badge {
            display: inline-block; min-width: 25px; padding: 3px 8px;
            border-radius: 12px; color: white; font-size: 0.85em;
            text-align: center; margin-right: 5px;
        }
        .bg-high { background-color: #e74c3c; }
        .bg-medium { background-color: #e67e22; }
        .bg-low { background-color: #f1c40f; color: #333; }
        .bg-info { background-color: #3498db; }
        .bg-false { background-color: #2ecc71; }

    </style>
</head>
<body>

<div class="upload-container">
    <input type="file" id="fileInput" style="display: none;" accept=".html,.xml,.json" multiple>

    <button class="btn-upload" onclick="document.getElementById('fileInput').click()">
        ğŸ“‚ æ‰¹æ¬¡ä¸Šå‚³å ±å‘Š
    </button>
</div>

<div id="uploadStatusBox" class="upload-status-box">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h4 style="margin: 0;">ä¸Šå‚³é€²åº¦ä½‡åˆ—</h4>
        <button onclick="document.getElementById('uploadStatusBox').style.display='none'"
                style="cursor:pointer; border:none; background:none; font-size: 1.2em; color:#888;">&times;</button>
    </div>
    <div id="statusList"></div>
</div>

<h1>Summary of Alerts</h1>

<div class="summary-container" id="globalSummary">
    <div>Loading...</div>
</div>

<hr style="border: 0; border-top: 1px solid #ddd; margin: 30px 0;">

<h2>Website Risk Breakdown</h2>

<div class="table-container">
    <table>
        <thead>
        <tr>
            <th>Website URL</th>
            <th>Risk Distribution (High / Med / Low / Info)</th>
        </tr>
        </thead>
        <tbody id="siteListBody">
        <tr><td colspan="2" style="text-align:center;">æ­£åœ¨è¼‰å…¥æ•¸æ“š...</td></tr>
        </tbody>
    </table>
</div>

<script>
    // è¨­å®š API ç¶²å€ (è«‹ç¢ºèªèˆ‡å¾Œç«¯ Controller ä¸€è‡´)
    const UPLOAD_API_URL = '/api/reports/upload';

    // é é¢è¼‰å…¥æ™‚ï¼Œå…ˆæŠ“ä¸€æ¬¡æ•¸æ“š
    loadDashboardData();

    // ç›£è½æª”æ¡ˆé¸æ“‡äº‹ä»¶ (æ”¯æ´å¤šæª”)
    document.getElementById('fileInput').addEventListener('change', async function(event) {
        const files = event.target.files;
        if (files.length === 0) return;

        // é¡¯ç¤ºå³ä¸‹è§’ç‹€æ…‹æ¡†
        const statusBox = document.getElementById('uploadStatusBox');
        const statusList = document.getElementById('statusList');
        statusBox.style.display = 'block';
        statusList.innerHTML = ''; // æ¸…ç©ºä¸Šä¸€æ¬¡çš„ç´€éŒ„

        // è¿´åœˆï¼šä¸€å€‹ä¸€å€‹è™•ç†æª”æ¡ˆ
        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            // 1. åœ¨æ¸…å–®ä¸­å»ºç«‹ä¸€å€‹æ–°çš„ç‹€æ…‹åˆ—
            const row = document.createElement('div');
            row.className = 'status-item';
            // ç”¢ç”Ÿå”¯ä¸€çš„ ID (ä¾‹å¦‚ status-0, status-1) ä»¥ä¾¿ç¨å¾Œæ›´æ–°æ–‡å­—
            const statusId = `status-${i}`;

            row.innerHTML = `
                    <span style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px;" title="${file.name}">
                        ${file.name}
                    </span>
                    <span id="${statusId}" class="status-loading">â³ è™•ç†ä¸­...</span>
                `;
            statusList.appendChild(row);

            // 2. å‘¼å«ä¸Šå‚³å‡½å¼ (await ç­‰å¾…ä¸Šå‚³å®Œç•¢æ‰æ›ä¸‹ä¸€å€‹ï¼Œé¿å…ä¼ºæœå™¨å¡è»Š)
            await uploadSingleFile(file, statusId);
        }

        // å…¨éƒ¨æª”æ¡ˆè·‘å®Œå¾Œï¼Œè‡ªå‹•åˆ·æ–°å„€è¡¨æ¿æ•¸æ“š
        loadDashboardData();

        // æ¸…ç©º inputï¼Œè®“ä½¿ç”¨è€…å¯ä»¥å†æ¬¡é¸æ“‡åŒæ¨£çš„æª”æ¡ˆ
        this.value = '';
    });

    // å°è£ï¼šå–®ä¸€æª”æ¡ˆä¸Šå‚³é‚è¼¯
    async function uploadSingleFile(file, statusId) {
        const formData = new FormData();
        formData.append('file', file);
        const statusSpan = document.getElementById(statusId);

        try {
            const response = await fetch(UPLOAD_API_URL, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // å¾Œç«¯å›å‚³ 200 OKï¼Œä»£è¡¨æˆåŠŸå„²å­˜ (å› ç‚ºå¾Œç«¯æœ‰å¯« delete existingï¼Œæ‰€ä»¥é€™ä¹Ÿæ˜¯æ›´æ–°æˆåŠŸçš„æ„æ€)
                statusSpan.innerHTML = 'âœ… å®Œæˆ/åˆ·æ–°';
                statusSpan.className = 'status-success';
            } else {
                // å¤±æ•—æ™‚ï¼Œè®€å–å¾Œç«¯å›å‚³çš„éŒ¯èª¤è¨Šæ¯
                const errorMsg = await response.text();
                statusSpan.innerHTML = 'âŒ å¤±æ•—';
                statusSpan.title = errorMsg; // æ»‘é¼ ç§»ä¸Šå»å¯ä»¥çœ‹åˆ°è©³ç´°éŒ¯èª¤åŸå› 
                statusSpan.className = 'status-error';
                console.error(`Upload failed for ${file.name}:`, errorMsg);
            }
        } catch (error) {
            console.error(error);
            statusSpan.innerHTML = 'âŒ é€£ç·šéŒ¯èª¤';
            statusSpan.className = 'status-error';
        }
    }

    // å°è£ï¼šè¼‰å…¥å„€è¡¨æ¿æ•¸æ“š (åœ“åœˆ + åˆ—è¡¨)
    function loadDashboardData() {
        // è¼‰å…¥åœ“åœˆ
        fetch('/api/dashboard/global')
            .then(res => res.json())
            .then(data => {
                const html = `
                        <div class="risk-circle border-high"><span class="risk-count">${data.high}</span><span class="risk-label">High</span></div>
                        <div class="risk-circle border-medium"><span class="risk-count">${data.medium}</span><span class="risk-label">Medium</span></div>
                        <div class="risk-circle border-low"><span class="risk-count">${data.low}</span><span class="risk-label">Low</span></div>
                        <div class="risk-circle border-info"><span class="risk-count">${data.informational}</span><span class="risk-label">Info</span></div>
                        <div class="risk-circle border-false"><span class="risk-count">${data.falsePositives}</span><span class="risk-label">False+</span></div>
                    `;
                document.getElementById('globalSummary').innerHTML = html;
            })
            .catch(err => console.error("ç„¡æ³•è¼‰å…¥å…¨åŸŸçµ±è¨ˆ", err));

        // è¼‰å…¥åˆ—è¡¨
        fetch('/api/dashboard/sites')
            .then(res => res.json())
            .then(sites => {
                let html = '';
                if (sites.length === 0) {
                    html = '<tr><td colspan="2" style="text-align:center;">ç›®å‰æ²’æœ‰è³‡æ–™ï¼Œè«‹ä¸Šå‚³å ±å‘Šã€‚</td></tr>';
                } else {
                    sites.forEach(site => {
                        html += `
                                <tr>
                                    <td><a href="${site.url}" target="_blank" class="site-link">${site.url}</a></td>
                                    <td>
                                        <span class="badge bg-high">${site.riskCounts.high}</span>
                                        <span class="badge bg-medium">${site.riskCounts.medium}</span>
                                        <span class="badge bg-low">${site.riskCounts.low}</span>
                                        <span class="badge bg-info">${site.riskCounts.informational}</span>
                                        <span class="badge bg-false">${site.riskCounts.falsePositives}</span>
                                    </td>
                                </tr>
                            `;
                    });
                }
                document.getElementById('siteListBody').innerHTML = html;
            })
            .catch(err => console.error("ç„¡æ³•è¼‰å…¥ç¶²ç«™åˆ—è¡¨", err));
    }
</script>
</body>
</html>